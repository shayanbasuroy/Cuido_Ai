<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cuido.AI Chat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        overflow-y: auto;
        transition: background 0.5s ease-in-out;
      }

      /* Theme backgrounds */
      .theme-blue {
        background: radial-gradient(at top left, #3b82f6, #1e3a8a);
      }
      .theme-purple {
        background: radial-gradient(at top left, #a78bfa, #6d28d9);
      }
      .theme-green {
        background: radial-gradient(at top left, #34d399, #059669);
      }
      .theme-orange {
        background: radial-gradient(at top left, #fb923c, #c2410c);
      }
      .theme-pink {
        background: radial-gradient(at top left, #fbcfe8, #db2777);
      }
      .theme-red {
        background: radial-gradient(at top left, #fca5a5, #dc2626);
      }
      .theme-premium {
        background: radial-gradient(
          at top left,
          #333333,
          #1a1a1a
        ); /* Dark gradient for premium */
      }

      /* Base glassmorphism effect for reusable components */
      .glass-base {
        background-color: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(15px) saturate(180%);
        -webkit-backdrop-filter: blur(15px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        color: #ffffff;
        text-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        border-radius: 2.5rem; /* Large, Apple-like rounded corners for main elements */
      }

      /* Animated Outline Glow Effect - Reverted */
      .animated-glass-glow {
        position: relative;
        overflow: hidden;
        z-index: 1; /* Ensure content is above the glow pseudo-element */
      }

      .animated-glass-glow::before {
        content: "";
        position: absolute;
        /* No animation or conic gradient here */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: inherit; /* Inherit border-radius from parent */
        pointer-events: none; /* Ensure it doesn't block interactions */
      }

      /* Removed @keyframes rotateGradient and @keyframes fadeGlow */

      /* Scrollbar styling for chat history and sidebar */
      .chat-history::-webkit-scrollbar,
      .sidebar-content::-webkit-scrollbar {
        width: 8px;
      }

      .chat-history::-webkit-scrollbar-track,
      .sidebar-content::-webkit-scrollbar-track {
        background: rgba(
          255,
          255,
          255,
          0.05
        ); /* Lighter, more transparent track */
        border-radius: 10px;
      }

      .chat-history::-webkit-scrollbar-thumb,
      .sidebar-content::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3); /* More transparent thumb */
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border for glass effect */
      }

      .chat-history::-webkit-scrollbar-thumb:hover,
      .sidebar-content::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5); /* Increase opacity on hover */
      }

      /* Custom input and button styling */
      .input-field {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ffffff;
        padding: 0.75rem 1rem;
        border-radius: 1.75rem; /* Rounded input field */
        outline: none;
        transition: all 0.2s ease-in-out;
      }

      .input-field:focus {
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }

      .send-button {
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #ffffff;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 1.75rem; /* Rounded send button */
        cursor: pointer;
        transition: all 0.3s ease-in-out, transform 0.1s ease-out; /* Added transform for animation */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .send-button:hover {
        transform: translateY(-3px) scale(1.02); /* Subtle bounce and scale on hover */
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }
      .send-button:active {
        transform: translateY(-1px) scale(0.98); /* Slight press effect on click */
      }

      .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .message-bubble {
        padding: 0.75rem 1.25rem;
        border-radius: 1.5rem; /* Consistent rounded message bubbles */
        margin-bottom: 0.75rem;
        max-width: 85%;
        word-wrap: break-word;
        line-height: 1.4;
        font-size: 0.95rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        animation: fadeInScale 0.3s ease-out; /* Pop-in animation for new messages */
      }

      @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .user-message {
        background-color: rgba(255, 255, 255, 0.15);
        align-self: flex-end;
        margin-left: auto;
      }

      .cuido-message {
        background-color: rgba(0, 0, 0, 0.1);
        align-self: flex-start;
        margin-right: auto;
        display: flex; /* Use flexbox for alignment */
        align-items: flex-end; /* Align items to the bottom */
        gap: 0.5rem; /* Space between text content and action buttons */
        padding-right: 0.5rem; /* Adjust padding to make space for the buttons */
      }
      .cuido-message .message-content {
        flex-grow: 1; /* Allow text content to take available space */
        word-break: break-word; /* Ensure long words wrap */
      }
      .cuido-message .message-actions {
        display: flex;
        flex-direction: column; /* Stack buttons vertically */
        gap: 0.25rem; /* Space between buttons */
        flex-shrink: 0; /* Prevent buttons from shrinking */
      }
      .cuido-message .action-button {
        /* Common style for speak and copy buttons */
        background-color: rgba(
          255,
          255,
          255,
          0.1
        ); /* Subtle glass background */
        border: 1px solid rgba(255, 255, 255, 0.2); /* Glass border */
        border-radius: 50%; /* Make it round */
        width: 32px; /* Fixed width */
        height: 32px; /* Fixed height */
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        color: #ffffff; /* White icon color */
        transition: background-color 0.2s ease-in-out, transform 0.1s ease-out,
          border-color 0.2s ease-in-out;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Subtle shadow */
      }
      .cuido-message .action-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
        border-color: rgba(255, 255, 255, 0.3);
      }
      .cuido-message .action-button:active {
        transform: scale(0.95);
      }

      /* Active state for speak button */
      .cuido-message .speak-button.active {
        background-color: rgba(74, 222, 128, 0.3); /* Green tint when active */
        border-color: rgba(74, 222, 128, 0.6);
        transform: scale(1.05);
      }

      /* Copied notification */
      .copied-notification {
        position: fixed;
        bottom: 6rem; /* Above the input area */
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: #ffffff;
        padding: 0.75rem 1.5rem;
        border-radius: 1.5rem;
        opacity: 0;
        transition: opacity 0.3s ease-out;
        pointer-events: none; /* Allow clicks to pass through */
        z-index: 100; /* Ensure it's above other elements */
      }
      .copied-notification.show {
        opacity: 1;
      }

      /* Removed .typing-indicator */

      /* Theme button styles */
      .theme-button {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.2s ease-in-out, border-color 0.2s ease-in-out;
      }
      .theme-button:hover {
        transform: scale(1.2); /* More prominent scale on hover */
        border-color: rgba(255, 255, 255, 0.6);
      }
      .theme-button.selected {
        border-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
      }

      /* Menu toggle button */
      .menu-toggle-button {
        background-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px) saturate(150%);
        -webkit-backdrop-filter: blur(5px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 30;
        color: #ffffff; /* Ensure icon color is white */
      }
      .menu-toggle-button:hover {
        background-color: rgba(255, 255, 255, 0.15);
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .chat-sidebar {
        position: fixed;
        top: 0;
        left: -100%; /* Initially off-screen */
        height: 100%;
        width: 70%;
        max-width: 300px;
        z-index: 25;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        transition: left 0.3s ease-in-out;
        background-color: rgba(
          255,
          255,
          255,
          0.08
        ); /* Slightly more opaque for sidebar background */
        backdrop-filter: blur(18px) saturate(180%);
        -webkit-backdrop-filter: blur(18px) saturate(180%);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
        border-radius: 0; /* Full height slide-out often has square corners on the slide-out edge */
      }

      .chat-sidebar.open {
        left: 0;
        border-radius: 0 2.5rem 2.5rem 0; /* Rounded right corners when open and acting as overlay */
      }

      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out;
      }

      .sidebar-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }

      .sidebar-content {
        padding: 1.5rem; /* Overall padding for content */
        padding-bottom: 0; /* Remove bottom padding for `mt-auto` button */
        flex-grow: 1;
        overflow-y: auto;
      }

      .dropdown-item {
        padding: 0.75rem 1rem;
        border-radius: 1.5rem; /* Rounded for list items */
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
        margin-bottom: 0.5rem;
        color: #ffffff;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .dropdown-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .dropdown-item.active {
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: 600;
      }

      .new-chat-button {
        width: calc(100% - 3rem); /* Full width minus total padding */
        margin: 1.5rem; /* Consistent padding around the button */
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #ffffff;
        font-weight: 600;
        padding: 0.75rem 1rem;
        border-radius: 1.75rem; /* Consistent rounded button */
        cursor: pointer;
        transition: all 0.3s ease-in-out, transform 0.1s ease-out; /* Added transform for animation */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        flex-shrink: 0; /* Prevent shrinking */
      }
      .new-chat-button:hover {
        transform: translateY(-3px) scale(1.02); /* Subtle bounce and scale on hover */
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
      }
      .new-chat-button:active {
        transform: translateY(-1px) scale(0.98); /* Slight press effect on click */
      }
      /* Default background for new chat button (overridden by JS theme) */
      .new-chat-button {
        background: linear-gradient(
          135deg,
          rgba(74, 222, 128, 0.8),
          rgba(34, 197, 94, 0.8)
        );
      }

      .delete-chat-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        font-size: 1rem;
        margin-left: 0.75rem;
        transition: color 0.2s ease-in-out;
      }
      .delete-chat-btn:hover {
        color: #ef4444; /* Red for delete */
      }

      /* New Keyframe for fade-in effect */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* New Keyframe for overall element fade-in (for modal) */
      @keyframes slideInFadeIn {
        from {
          opacity: 0;
          transform: translateY(50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animated-modal {
        animation: slideInFadeIn 0.5s ease-out forwards;
      }

      /* Main content panel (the single central glass box) */
      /* This will be the main container visible to the user */
      .main-content-panel {
        padding: 1.5rem; /* Inner padding for content */
        border-radius: 2.5rem; /* Inherit from glass-base */
        animation: fadeIn 0.8s ease-out forwards; /* Added animation */
      }

      /* Inner chat history display area - the separate liquid glass box for messages */
      .chat-history-display {
        background-color: rgba(
          255,
          255,
          255,
          0.03
        ); /* Lighter transparency for inner glass */
        backdrop-filter: blur(10px) saturate(150%); /* Slightly less blur for inner */
        -webkit-backdrop-filter: blur(10px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.08); /* Lighter border for inner glass */
        border-radius: 2rem; /* Rounded for inner chat area, slightly less than main panel */
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle inner shadow */
      }

      /* Initial hidden state for animated elements */
      .main-content-panel,
      footer {
        opacity: 0; /* Start hidden for animation */
      }

      /* Responsive adjustments */
      @media (min-width: 768px) {
        body {
          padding: 2rem;
        }
        /* The overall chat experience is now handled by .main-content-panel */
        .main-content-panel {
          height: 90vh; /* Full height for desktop */
          width: 90%; /* Max width for desktop */
          max-width: 800px; /* Limit overall width */
        }

        /* Sidebar always acts as a fixed slide-out overlay, regardless of screen size */
        .chat-sidebar {
          position: fixed;
          top: 0;
          left: -100%; /* Keep off-screen by default */
          height: 100%;
          width: 70%;
          max-width: 300px;
          z-index: 25;
          flex-shrink: 0;
          display: flex;
          flex-direction: column;
          transition: left 0.3s ease-in-out;
          background-color: rgba(
            255,
            255,
            255,
            0.08
          ); /* Slightly more opaque for sidebar background */
          backdrop-filter: blur(18px) saturate(180%);
          -webkit-backdrop-filter: blur(18px) saturate(180%);
          border-right: 1px solid rgba(255, 255, 255, 0.1);
          box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
          border-radius: 0; /* Full height slide-out often has square corners on the slide-out edge */
        }

        .chat-sidebar.open {
          left: 0;
          border-radius: 0 2.5rem 2.5rem 0; /* Rounded right corners when open and acting as overlay */
        }

        /* Overlay for sidebar remains functional on desktop too */
        .sidebar-overlay {
          /* Display and opacity controlled by JS */
        }

        /* Header layout for larger screens */
        .header-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
          padding: 0 1.5rem; /* Add horizontal padding to header */
          position: relative; /* Ensure absolute positioning works relative to this */
        }
        .header-content .menu-toggle-button {
          position: static; /* Make it part of flex flow */
          margin-right: 1rem; /* Space from title */
        }
        .header-content .text-center {
          flex-grow: 1; /* Allow title to take available space */
          text-align: center;
        }
        .header-content .theme-switcher-container {
          /* New container for theme buttons */
          margin-left: 1rem; /* Space from title */
        }
        /* Adjustments for theme switcher within flex container */
        .header-content .flex {
          /* This targets the actual flex div for theme buttons */
          position: static; /* Remove absolute positioning */
          top: auto;
          right: auto;
          justify-content: flex-end; /* Align to the right within its flex item */
          flex-wrap: wrap; /* Allow wrapping on very narrow desktop */
          gap: 0.75rem; /* Consistent gap between theme buttons */
        }
        .menu-toggle-button {
          /* Ensure it's still clickable and visually distinct */
          position: absolute;
          top: 1.5rem;
          left: 1.5rem;
        }
        .new-chat-button {
          width: calc(100% - 3rem);
        }
      }

      @media (max-width: 767px) {
        .main-content-panel {
          height: 95vh;
          width: 95%;
          padding: 1rem;
        }
        /* Header layout for mobile screens */
        .header-content {
          display: flex;
          flex-wrap: wrap; /* Allow elements to wrap */
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          padding: 0 1rem; /* Adjust padding for mobile */
          position: relative;
        }
        .header-content .menu-toggle-button {
          position: static; /* Make it part of flex flow */
          margin-right: 0.5rem; /* Space from title */
          order: 1; /* First item */
        }
        .header-content .text-center {
          flex-grow: 1;
          text-align: center;
          order: 2; /* Second item */
          margin-left: 0.5rem; /* Space from menu button */
          margin-right: 0.5rem; /* Space from theme buttons */
        }
        .header-content .theme-switcher-container {
          /* New container for theme buttons */
          order: 3; /* Third item */
          margin-left: auto; /* Push to the right */
        }
        .header-content .flex {
          /* This targets the actual flex div for theme buttons */
          position: static; /* Remove absolute positioning */
          top: auto;
          right: auto;
          justify-content: flex-end; /* Align to the right within its flex item */
          flex-wrap: wrap; /* Allow wrapping on very narrow desktop */
          gap: 0.5rem; /* Smaller gap on mobile */
        }
        .menu-toggle-button {
          /* On mobile, keep it slightly more accessible */
          position: absolute;
          top: 1rem;
          left: 1rem;
          width: 36px; /* Slightly smaller for mobile */
          height: 36px;
        }
      }

      /* Language selector styling */
      .language-selector {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ffffff;
        padding: 0.75rem 1rem;
        border-radius: 1.75rem; /* Rounded dropdown */
        outline: none;
        transition: all 0.2s ease-in-out;
        appearance: none; /* Remove default dropdown arrow */
        -webkit-appearance: none;
        -moz-appearance: none;
        cursor: pointer;
        flex-shrink: 0; /* Prevent shrinking */
        font-size: 0.9rem;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-chevron-down'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1em;
        padding-right: 2.5rem; /* Space for the custom arrow */
      }

      .language-selector:focus {
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }

      .language-selector option {
        background-color: #333333; /* Dark background for options for readability */
        color: #ffffff;
      }
    </style>
  </head>
  <body class="antialiased theme-blue">
    <!-- Overlay for welcome modal (hidden by default) -->
    <div
      id="welcome-modal-overlay"
      class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden"
    >
      <div
        id="welcome-modal-content"
        class="glass-base p-8 w-11/12 max-w-md flex flex-col items-center text-center animated-modal animated-glass-glow"
      >
        <h2 class="text-3xl font-bold mb-4">Welcome to Cuido.AI!</h2>
        <p class="text-lg opacity-80 mb-6">What should I call you?</p>
        <input
          type="text"
          id="welcome-user-name-input"
          placeholder="Enter your name"
          class="input-field w-full mb-6"
        />
        <button id="welcome-save-name-btn" class="send-button w-full">
          Let's Chat!
        </button>
      </div>
    </div>

    <!-- Overlay for sidebar (for both mobile and desktop now) -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Chat Sidebar (Always a slide-out, toggled by menu icon) -->
    <div id="chat-sidebar" class="chat-sidebar glass-base animated-glass-glow">
      <div class="sidebar-content">
        <h2 class="text-2xl font-bold mb-4 text-center">Chats</h2>
        <div class="flex flex-col gap-2" id="chat-sessions-list">
          <!-- Chat sessions will be rendered here -->
        </div>
      </div>
      <button id="new-chat-button" class="new-chat-button">+ New Chat</button>
    </div>

    <!-- Main Content Panel (The primary visible chat area, now a single glass box) -->
    <div
      class="main-content-panel glass-base animated-glass-glow w-full max-w-2xl flex flex-col h-[90vh] md:h-[80vh] md:max-w-4xl"
    >
      <!-- Header -->
      <header class="header-content mb-6 relative">
        <!-- Menu Toggle Button -->
        <button id="menu-toggle-button" class="menu-toggle-button">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="feather feather-menu"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div class="text-center flex-grow">
          <h1
            class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-blue-500 mb-2"
          >
            Cuido.AI
          </h1>
          <p class="text-sm opacity-80">Your Personal AI Assistant</p>
        </div>
        <!-- Theme Switcher -->
        <div class="flex justify-center gap-3 theme-switcher-container">
          <div
            id="theme-blue-btn"
            class="theme-button bg-blue-500"
            data-theme="theme-blue"
            title="Blue Theme"
          ></div>
          <div
            id="theme-purple-btn"
            class="theme-button bg-purple-500"
            data-theme="theme-purple"
            title="Purple Theme"
          ></div>
          <div
            id="theme-green-btn"
            class="theme-button bg-green-500"
            data-theme="theme-green"
            title="Green Theme"
          ></div>
          <div
            id="theme-orange-btn"
            class="theme-button bg-orange-500"
            data-theme="theme-orange"
            title="Orange Theme"
          ></div>
          <div
            id="theme-pink-btn"
            class="theme-button bg-pink-500"
            data-theme="theme-pink"
            title="Pink Theme"
          ></div>
          <div
            id="theme-red-btn"
            class="theme-button bg-red-500"
            data-theme="theme-red"
            title="Red Theme"
          ></div>
          <!-- New Premium Theme Button -->
          <div
            id="theme-premium-btn"
            class="theme-button"
            data-theme="theme-premium"
            title="Premium Theme"
            style="background: linear-gradient(135deg, #ffd700, #daa520)"
          ></div>
        </div>
      </header>

      <!-- Chat History Display Container (the inner liquid glass box) -->
      <div
        class="chat-history-display glass-base flex-grow overflow-y-auto p-4"
      >
        <main class="flex flex-col" id="chat-history">
          <!-- Messages will be appended here -->
        </main>
      </div>

      <!-- Input Area -->
      <div
        class="input-area mt-4 flex flex-col md:flex-row gap-2 items-center md:items-end w-full"
      >
        <!-- Textarea for user input, ordered first on mobile and takes full width -->
        <textarea
          id="user-input"
          class="input-field flex-grow resize-none min-h-[3.5rem] overflow-hidden transition-all duration-300 ease-in-out order-1 md:order-none w-full"
          placeholder="Type your message..."
          rows="1"
        ></textarea>
        <!-- Container for language selector and send button, ordered second on mobile -->
        <div class="flex w-full md:w-auto gap-2 order-2 md:order-none">
          <!-- Language Selector -->
          <select
            id="language-selector"
            class="language-selector flex-shrink-0"
          >
            <option value="English">English</option>
            <option value="French">Français</option>
            <option value="German">Deutsch</option>
            <option value="Spanish">Español</option>
            <option value="Afrikaans">Afrikaans</option>
            <option value="Albanian">Albanian</option>
            <option value="Amharic">Amharic</option>
            <option value="Arabic">Arabic</option>
            <option value="Armenian">Armenian</option>
            <option value="Azerbaijani">Azerbaijani</option>
            <option value="Basque">Basque</option>
            <option value="Belarusian">Belarusian</option>
            <option value="Bengali">Bengali</option>
            <option value="Bosnian">Bosnian</option>
            <option value="Bulgarian">Bulgarian</option>
            <option value="Burmese">Burmese</option>
            <option value="Catalan">Catalan</option>
            <option value="Cebuano">Cebuano</option>
            <option value="Chinese">中文</option>
            <option value="Croatian">Croatian</option>
            <option value="Czech">Czech</option>
            <option value="Danish">Danish</option>
            <option value="Dutch">Dutch</option>
            <option value="Estonian">Estonian</option>
            <option value="Filipino">Filipino</option>
            <option value="Finnish">Finnish</option>
            <option value="Galician">Galician</option>
            <option value="Georgian">Georgian</option>
            <option value="Greek">Greek</option>
            <option value="Gujarati">Gujarati</option>
            <option value="Haitian Creole">Haitian Creole</option>
            <option value="Hausa">Hausa</option>
            <option value="Hebrew">Hebrew</option>
            <option value="Hindi">Hindi</option>
            <option value="Hungarian">Hungarian</option>
            <option value="Icelandic">Icelandic</option>
            <option value="Igbo">Igbo</option>
            <option value="Indonesian">Indonesian</option>
            <option value="Irish">Irish</option>
            <option value="Italian">Italian</option>
            <option value="Japanese">Japanese</option>
            <option value="Javanese">Javanese</option>
            <option value="Kannada">Kannada</option>
            <option value="Kazakh">Kazakh</option>
            <option value="Khmer">Khmer</option>
            <option value="Korean">Korean</option>
            <option value="Kurdish">Kurdish</option>
            <option value="Kyrgyz">Kyrgyz</option>
            <option value="Lao">Lao</option>
            <option value="Latvian">Latvian</option>
            <option value="Lithuanian">Lithuanian</option>
            <option value="Luxembourgish">Luxembourgish</option>
            <option value="Macedonian">Macedonian</option>
            <option value="Malay">Malay</option>
            <option value="Malayalam">Malayalam</option>
            <option value="Maltese">Maltese</option>
            <option value="Maori">Maori</option>
            <option value="Marathi">Marathi</option>
            <option value="Mongolian">Mongolian</option>
            <option value="Nepali">Nepali</option>
            <option value="Norwegian">Norwegian</option>
            <option value="Pashto">Pashto</option>
            <option value="Persian">Persian</option>
            <option value="Polish">Polish</option>
            <option value="Portuguese">Portuguese</option>
            <option value="Punjabi">Punjabi</option>
            <option value="Romanian">Romanian</option>
            <option value="Russian">Russian</option>
            <option value="Samoan">Samoan</option>
            <option value="Serbian">Serbian</option>
            <option value="Sindhi">Sindhi</option>
            <option value="Sinhala">Sinhala</option>
            <option value="Slovak">Slovak</option>
            <option value="Slovenian">Slovenian</option>
            <option value="Somali">Somali</option>
            <option value="Swahili">Swahili</option>
            <option value="Swedish">Swedish</option>
            <option value="Tagalog">Tagalog</option>
            <option value="Tamil">Tamil</option>
            <option value="Telugu">Telugu</option>
            <option value="Thai">Thai</option>
            <option value="Turkish">Turkish</option>
            <option value="Ukrainian">Ukrainian</option>
            <option value="Urdu">Urdu</option>
            <option value="Uzbek">Uzbek</option>
            <option value="Vietnamese">Vietnamese</option>
            <option value="Welsh">Welsh</option>
            <option value="Xhosa">Xhosa</option>
            <option value="Yiddish">Yiddish</option>
            <option value="Yoruba">Yoruba</option>
            <option value="Zulu">Zulu</option>
          </select>
          <button id="send-button" class="send-button flex-shrink-0">
            Send
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer
      class="glass-base w-full max-w-2xl text-center py-3 text-sm opacity-80 mt-4"
    >
      <span>© 2025 Cuido.AI</span>
    </footer>

    <!-- Copied Notification -->
    <div id="copied-notification" class="copied-notification">Copied!</div>

    <script type="module">
      // Gemini API Key from the user.
      const GEMINI_API_KEY = "AIzaSyCK83VJUG-NWzNJWBgNGxM3Ze6i-SEAUP0";
      const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

      // Global variables
      let currentChatId = null; // Stores the ID of the currently active chat
      let chatSessions = []; // Stores an array of { id, name } for each chat
      let isWaitingForResponse = false; // Flag to prevent multiple requests
      let chatHistory = []; // Ensure this is explicitly set here

      // DOM Elements (declared after global variables for hoisting clarity)
      const chatHistoryDiv = document.getElementById("chat-history");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const body = document.body;
      const chatSidebar = document.getElementById("chat-sidebar");
      const chatSessionsList = document.getElementById("chat-sessions-list");
      const newChatButton = document.getElementById("new-chat-button");
      const themeButtons = document.querySelectorAll(".theme-button");
      const menuToggleButton = document.getElementById("menu-toggle-button");
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      const welcomeModalOverlay = document.getElementById(
        "welcome-modal-overlay"
      );
      const welcomeUserNameInput = document.getElementById(
        "welcome-user-name-input"
      );
      const welcomeSaveNameBtn = document.getElementById(
        "welcome-save-name-btn"
      );
      const mainContentPanel = document.querySelector(".main-content-panel");
      const footerElement = document.querySelector("footer");
      const copiedNotification = document.getElementById("copied-notification");
      const languageSelector = document.getElementById("language-selector");

      // Define complementary gradients for send button based on theme
      const sendButtonGradients = {
        "theme-blue":
          "linear-gradient(135deg, rgba(74, 222, 128, 0.8), rgba(34, 197, 94, 0.8))", // Green for Blue
        "theme-purple":
          "linear-gradient(135deg, rgba(251, 191, 36, 0.8), rgba(217, 119, 6, 0.8))", // Yellow/Orange for Purple
        "theme-green":
          "linear-gradient(135deg, rgba(251, 113, 133, 0.8), rgba(220, 38, 38, 0.8))", // Rose/Red for Green
        "theme-orange":
          "linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(29, 78, 216, 0.8))", // Blue for Orange
        "theme-pink":
          "linear-gradient(135deg, rgba(16, 185, 129, 0.8), rgba(5, 150, 105, 0.8))", // Teal/Green for Pink
        "theme-red":
          "linear-gradient(135deg, rgba(96, 165, 250, 0.8), rgba(37, 99, 235, 0.8))", // Light Blue for Red
        "theme-premium": "linear-gradient(135deg, #FFD700, #DAA520)", // Golden gradient for premium theme
      };

      /**
       * Converts Markdown text to HTML.
       * Handles bold (`**text**`), italics (`*text*`), bold-italics (`***text***`), and newlines.
       * @param {string} markdownText - The input text with Markdown.
       * @returns {string} - The HTML string.
       */
      function convertMarkdownToHtml(markdownText) {
        let htmlText = markdownText;

        // Handle bold-italics: ***text***
        htmlText = htmlText.replace(
          /\*\*\*(.*?)\*\*\*/g,
          "<em><strong>$1</strong></em>"
        );
        // Handle bold: **text**
        htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        // Handle italics: *text*
        htmlText = htmlText.replace(/\*(.*?)\*/g, "<em>$1</em>");
        // Handle newlines
        htmlText = htmlText.replace(/\n/g, "<br>");

        return htmlText;
      }

      /**
       * Automatically resizes a textarea based on its scrollHeight.
       * @param {HTMLTextAreaElement} textareaElement - The textarea element to resize.
       */
      function autoResizeTextarea(textareaElement) {
        textareaElement.style.height = ""; // Reset height to recalculate
        textareaElement.style.height = textareaElement.scrollHeight + "px";
      }

      // Function definitions (hoisted to the top of module scope)
      // Function to send message to Gemini API
      async function sendMessage() {
        let prompt = userInput.value.trim();
        if (!prompt || isWaitingForResponse) {
          return;
        }

        const selectedLanguage = languageSelector.value;
        // Prepend the language instruction to the prompt
        if (selectedLanguage !== "English") {
          // Only prepend if not English, as English is default
          prompt = `Reply in ${selectedLanguage}: ${prompt}`;
        }

        // Display user message immediately
        displayMessage("user", userInput.value.trim()); // Display original user input
        userInput.value = ""; // Clear input
        userInput.style.height = "auto"; // Reset textarea height
        isWaitingForResponse = true;
        sendButton.disabled = true; // Disable send button
        // showTypingIndicator(); // Removed: No longer showing typing indicator

        let chatHistoryForAPI = [];
        // Prepare chat history for the API, ensuring it's in the correct format
        // The Gemini API expects roles 'user' and 'model'.
        loadChatHistory(currentChatId).forEach((msg) => {
          chatHistoryForAPI.push({
            role: msg.role === "user" ? "user" : "model",
            parts: [{ text: msg.text }],
          });
        });
        // Add the current user prompt (with language instruction) to the history for this request
        chatHistoryForAPI.push({ role: "user", parts: [{ text: prompt }] });

        try {
          const payload = {
            contents: chatHistoryForAPI,
          };

          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();

          if (
            result.candidates &&
            result.candidates.length > 0 &&
            result.candidates[0].content &&
            result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0
          ) {
            const aiResponse = result.candidates[0].content.parts[0].text;
            displayMessage("cuido", aiResponse); // Display Cuido.AI's response
          } else {
            console.error("Unexpected API response structure:", result);
            // Check for specific error message from Gemini API
            if (
              result.error &&
              result.error.status === "UNAVAILABLE" &&
              result.error.message.includes("overloaded")
            ) {
              displayMessage(
                "cuido",
                "Cuido.AI is currently busy. Please try sending your message again in a moment!"
              );
            } else {
              displayMessage(
                "cuido",
                "Sorry, I couldn't get a response from Cuido.AI. Please try again."
              );
            }
          }
        } catch (error) {
          console.error("Error communicating with Gemini API:", error);
          displayMessage(
            "cuido",
            "Oops! Something went wrong while connecting to Cuido.AI. Please check your internet connection or try again later."
          );
        } finally {
          // removeTypingIndicator(); // Removed: No longer removing typing indicator
          isWaitingForResponse = false;
          sendButton.disabled = false; // Re-enable send button
          scrollToBottom();
        }
      }

      // Utility function to generate a unique ID
      function generateUniqueId() {
        return (
          "chat_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9)
        );
      }

      // Function to load all chat sessions meta-data from local storage
      function loadChatSessions() {
        try {
          const storedSessions = localStorage.getItem("cuidoChatSessions");
          if (storedSessions) {
            chatSessions = JSON.parse(storedSessions);
          } else {
            chatSessions = [];
          }
        } catch (error) {
          console.error("Failed to load chat sessions:", error);
          localStorage.removeItem("cuidoChatSessions");
          chatSessions = [];
        }
      }

      // Function to save all chat sessions meta-data to local storage
      function saveChatSessions() {
        localStorage.setItem("cuidoChatSessions", JSON.stringify(chatSessions));
      }

      // Function to load chat history for a specific chat ID
      function loadChatHistory(chatId) {
        try {
          const history = localStorage.getItem(`cuidoChatHistory_${chatId}`);
          return history ? JSON.parse(history) : [];
        } catch (error) {
          console.error(`Failed to load chat history for ${chatId}:`, error);
          localStorage.removeItem(`cuidoChatHistory_${chatId}`);
          return [];
        }
      }

      // Function to save chat history for a specific chat ID
      function saveChatHistory(chatId, history) {
        localStorage.setItem(
          `cuidoChatHistory_${chatId}`,
          JSON.stringify(history)
        );
      }

      // Function to display a message in the chat UI
      function displayMessage(role, text, shouldSave = true) {
        const messageBubble = document.createElement("div");
        messageBubble.classList.add("message-bubble");

        if (role === "user") {
          messageBubble.classList.add(
            "user-message",
            "bg-blue-600/30"
          ); /* User messages with a blue tint */
          messageBubble.textContent = text;
        } else {
          messageBubble.classList.add(
            "cuido-message",
            "bg-gray-700/30"
          ); /* AI messages with a darker tint */

          // Create a container for the text content
          const messageContentContainer = document.createElement("div");
          messageContentContainer.classList.add("message-content");
          // Use innerHTML to render Markdown converted to HTML
          messageContentContainer.innerHTML = convertMarkdownToHtml(text);
          messageBubble.appendChild(messageContentContainer);

          // Create a container for the action buttons
          const messageActionsContainer = document.createElement("div");
          messageActionsContainer.classList.add("message-actions");
          messageBubble.appendChild(messageActionsContainer);

          // Create the speak button
          const speakButton = document.createElement("button");
          speakButton.classList.add("action-button", "speak-button");
          speakButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M23.31 1.69a16 16 0 0 1 0 20.62"></path></svg>`;
          speakButton.title = "Speak message";
          // Pass original text and the button element to speakMessage for toggle functionality
          speakButton.onclick = (event) =>
            speakMessage(text, event.currentTarget);
          messageActionsContainer.appendChild(speakButton);

          // Create the copy button
          const copyButton = document.createElement("button");
          copyButton.classList.add("action-button", "copy-button");
          copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
          copyButton.title = "Copy message";
          copyButton.onclick = () => copyMessage(text);
          messageActionsContainer.appendChild(copyButton);
        }

        chatHistoryDiv.appendChild(messageBubble);

        if (shouldSave) {
          // Only add to current chat history if it's the active session
          const activeChatIndex = chatSessions.findIndex(
            (session) => session.id === currentChatId
          );
          if (activeChatIndex !== -1) {
            // Re-load the history for the *current* chat ID before pushing
            let history = loadChatHistory(currentChatId);
            history.push({ role, text });
            saveChatHistory(currentChatId, history);

            // Update chat name if it's the first message
            if (history.length === 1 && role === "user") {
              const defaultChatName = "New Chat";
              if (chatSessions[activeChatIndex].name === defaultChatName) {
                // Take first few words of the user's first message as chat name
                const newName = text.split(" ").slice(0, 3).join(" ") + "...";
                chatSessions[activeChatIndex].name = newName;
                saveChatSessions();
                renderChatSessions(); // Re-render menu to update name
              }
            }
          }
        }
        scrollToBottom();
      }

      // Function to speak the given text using Web Speech API
      function speakMessage(text, buttonElement) {
        if (!("speechSynthesis" in window)) {
          console.warn("Web Speech API is not supported in this browser.");
          // Optionally provide a visual message to the user that speech is not supported
          return;
        }

        // If currently speaking, cancel and reset button state
        if (window.speechSynthesis.speaking) {
          window.speechSynthesis.cancel();
          // Remove active state from all speak buttons, in case multiple are active
          document
            .querySelectorAll(".speak-button.active")
            .forEach((btn) => btn.classList.remove("active"));
          // If the cancelled speech was initiated by *this* button, then just return after cancelling
          if (buttonElement && buttonElement.classList.contains("active")) {
            buttonElement.classList.remove("active");
            return; // Stop here if we just cancelled the current button's speech
          }
        }

        // Clear any pending utterances before starting new speech
        window.speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "en-US"; // Default language
        utterance.volume = 1; // 0 to 1
        utterance.rate = 1; // 0.1 to 10
        utterance.pitch = 1; // 0 to 2

        // Attempt to find a preferred voice (e.g., a Google US English voice)
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(
          (voice) => voice.name.includes("Google") && voice.lang === "en-US"
        );
        if (preferredVoice) {
          utterance.voice = preferredVoice;
        }

        // Event handlers for when speech ends or errors
        utterance.onend = () => {
          if (buttonElement) {
            buttonElement.classList.remove("active");
          }
        };
        utterance.onerror = (event) => {
          console.error("Speech synthesis error:", event);
          if (buttonElement) {
            buttonElement.classList.remove("active");
          }
        };

        window.speechSynthesis.speak(utterance);
        if (buttonElement) {
          buttonElement.classList.add("active"); // Add active class when speaking starts
        }
      }

      // Function to copy text to clipboard
      function copyMessage(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed"; // Keep it off-screen
        textarea.style.left = "-9999px";
        document.body.appendChild(textarea);
        textarea.select();
        try {
          const successful = document.execCommand("copy");
          if (successful) {
            showCopiedNotification();
          } else {
            console.error("Fallback: Copying text command was unsuccessful.");
          }
        } catch (err) {
          console.error("Fallback: Oops, unable to copy", err);
        }
        document.body.removeChild(textarea);
      }

      // Function to show "Copied!" notification
      function showCopiedNotification() {
        copiedNotification.classList.add("show");
        setTimeout(() => {
          copiedNotification.classList.remove("show");
        }, 1500); // Hide after 1.5 seconds
      }

      // Function to scroll chat history to the bottom
      function scrollToBottom() {
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
      }

      // showTypingIndicator() function removed
      // removeTypingIndicator() function removed

      // Function to apply a selected theme
      function applyTheme(themeClass, save = true) {
        // Remove existing theme classes
        body.classList.remove(
          "theme-blue",
          "theme-purple",
          "theme-green",
          "theme-orange",
          "theme-pink",
          "theme-red",
          "theme-premium"
        );
        // Add the new theme class
        body.classList.add(themeClass);

        // Apply complementary gradient to send button
        sendButton.style.background = sendButtonGradients[themeClass];
        // Apply complementary gradient to new chat button
        newChatButton.style.background = sendButtonGradients[themeClass];

        // Update selected state for theme buttons
        themeButtons.forEach((button) => {
          if (button.dataset.theme === themeClass) {
            button.classList.add("selected");
          } else {
            button.classList.remove("selected");
          }
        });

        if (save) {
          localStorage.setItem("cuidoTheme", themeClass);
        }
      }

      // Function to render chat sessions in the sidebar
      function renderChatSessions() {
        chatSessionsList.innerHTML = ""; // Clear existing list
        chatSessions.forEach((session) => {
          const sessionItem = document.createElement("div");
          sessionItem.classList.add("dropdown-item"); // Re-using dropdown-item styles
          if (session.id === currentChatId) {
            sessionItem.classList.add("active");
          }
          sessionItem.dataset.chatId = session.id;
          sessionItem.innerHTML = `
                    <span class="truncate">${session.name}</span>
                    <button class="delete-chat-btn" data-chat-id="${session.id}">
                        &times;
                    </button>
                `;
          chatSessionsList.appendChild(sessionItem);
        });

        // Add event listeners for switching chats
        chatSessionsList.querySelectorAll(".dropdown-item").forEach((item) => {
          item.addEventListener("click", (event) => {
            // Only switch if not clicking the delete button
            if (!event.target.classList.contains("delete-chat-btn")) {
              const chatId = item.dataset.chatId;
              if (chatId !== currentChatId) {
                switchChat(chatId);
                // Close sidebar after selection
                if (chatSidebar) {
                  chatSidebar.classList.remove("open");
                  sidebarOverlay.classList.remove("visible");
                }
              }
            }
          });
        });

        // Add event listeners for deleting chats
        chatSessionsList.querySelectorAll(".delete-chat-btn").forEach((btn) => {
          btn.addEventListener("click", (event) => {
            event.stopPropagation(); // Prevent the parent dropdown-item click
            const chatIdToDelete = btn.dataset.chatId;
            deleteChat(chatIdToDelete);
          });
        });
      }

      // Function to create a new chat session
      function createNewChat() {
        const newId = generateUniqueId();
        const newSession = { id: newId, name: "New Chat" };
        chatSessions.push(newSession);
        saveChatSessions();
        switchChat(newId);

        // Add a greeting message immediately after creating and switching to the new chat
        const userName = localStorage.getItem("userName");
        const greeting = userName
          ? `Welcome, ${userName}! Let's start chatting.`
          : `Hello there! How can I assist you today?`;
        displayMessage("cuido", greeting, true); // Pass true to save this initial message

        // Close sidebar after creation
        if (chatSidebar) {
          chatSidebar.classList.remove("open");
          sidebarOverlay.classList.remove("visible");
        }
      }

      // Function to switch to a different chat session
      function switchChat(chatId) {
        // Save current chat history *before* changing currentChatId
        if (currentChatId) {
          const historyToSave = loadChatHistory(currentChatId); // Load the actual history to save
          if (historyToSave.length > 0) {
            // Only save if there's content
            saveChatHistory(currentChatId, historyToSave);
          }
        }

        currentChatId = chatId;
        // Now load the history for the new currentChatId and update the global chatHistory
        chatHistory = loadChatHistory(currentChatId);
        localStorage.setItem("cuidoLastActiveChat", currentChatId); // Save last active chat ID

        // Clear current chat display and render new history
        chatHistoryDiv.innerHTML = "";
        chatHistory.forEach((message) =>
          displayMessage(message.role, message.text, false)
        ); // Don't save again
        scrollToBottom();
        renderChatSessions(); // Update active state in sidebar
      }

      // Function to delete a chat session
      function deleteChat(chatIdToDelete) {
        // Placeholder for a custom confirm dialog
        const confirmed = true;

        if (!confirmed) return;

        // Remove from chatSessions array
        chatSessions = chatSessions.filter(
          (session) => session.id !== chatIdToDelete
        );
        saveChatSessions();

        // Remove from local storage
        localStorage.removeItem(`cuidoChatHistory_${chatIdToDelete}`);

        // If the deleted chat was the current one, switch to the latest chat or create a new one
        if (chatIdToDelete === currentChatId) {
          if (chatSessions.length > 0) {
            switchChat(chatSessions[chatSessions.length - 1].id);
          } else {
            createNewChat();
          }
        } else {
          renderChatSessions();
        }
      }

      // Function to initialize the application
      function initializeApp() {
        loadChatSessions();
        if (chatSessions.length === 0) {
          createNewChat();
        } else {
          const lastActiveChatId = localStorage.getItem("cuidoLastActiveChat");
          const initialChatId =
            lastActiveChatId &&
            chatSessions.some((s) => s.id === lastActiveChatId)
              ? lastActiveChatId
              : chatSessions[0].id;
          switchChat(initialChatId);

          // Only show welcome message if chat history is empty for the current chat
          if (chatHistory.length === 0) {
            const userName = localStorage.getItem("userName");
            const greeting = userName
              ? `Welcome, ${userName}! Let's start chatting.`
              : `Hello there! How can I assist you today?`;
            displayMessage("cuido", greeting, true);
          }
        }
        const savedTheme = localStorage.getItem("cuidoTheme") || "theme-blue";
        applyTheme(savedTheme, false);

        // Load and set saved language preference, or default to English
        const savedLanguage = localStorage.getItem("cuidoPreferredLanguage");
        if (savedLanguage) {
          languageSelector.value = savedLanguage;
        } else {
          languageSelector.value = "English"; // Default to English if no preference is saved
        }

        renderChatSessions(); // Initial rendering of chat sessions

        // New logic for welcoming user (modal only if name is not set)
        const userName = localStorage.getItem("userName");
        if (!userName) {
          // Show modal to ask for name
          welcomeModalOverlay.classList.remove("hidden");
          welcomeModalOverlay.classList.add("flex"); // Use flex to center content
          welcomeUserNameInput.focus(); // Focus on the input field

          welcomeSaveNameBtn.onclick = () => {
            const enteredName = welcomeUserNameInput.value.trim();
            if (enteredName) {
              localStorage.setItem("userName", enteredName);
              welcomeModalOverlay.classList.remove("flex");
              welcomeModalOverlay.classList.add("hidden");
              // For the very first-time user after entering name in modal, give a direct greeting:
              displayMessage(
                "cuido",
                `Welcome, ${enteredName}! Let's start chatting.`
              );

              // Ensure the new chat button gets its themed background after name is saved
              applyTheme(
                localStorage.getItem("cuidoTheme") || "theme-blue",
                false
              );
            } else {
              // Optionally add some visual feedback if name is empty
              welcomeUserNameInput.placeholder = "Please enter your name!";
              welcomeUserNameInput.classList.add("border-red-500"); // Add a red border for feedback
            }
          };

          // Allow pressing Enter in the input to save name
          welcomeUserNameInput.onkeydown = (event) => {
            if (event.key === "Enter") {
              event.preventDefault(); // Prevent default Enter key behavior (e.g., newline)
              welcomeSaveNameBtn.click(); // Programmatically click the save button
            }
          };
        }
      }

      // Event Listeners
      document.addEventListener("DOMContentLoaded", () => {
        // Ensure voices are loaded before trying to use them (important for some browsers)
        window.speechSynthesis.onvoiceschanged = () => {
          // This event fires when voices are ready.
          // You can potentially call speakMessage with a predefined welcome message here if the modal was dismissed
          // and the user name was already present.
        };

        if (sendButton) sendButton.addEventListener("click", sendMessage);

        if (userInput) {
          userInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter" && !event.shiftKey) {
              event.preventDefault();
              sendMessage();
            }
          });
          // Add this listener to handle dynamic textarea resizing
          userInput.addEventListener("input", () => {
            autoResizeTextarea(userInput);
          });
        }

        // Save language preference when changed
        if (languageSelector) {
          languageSelector.addEventListener("change", () => {
            localStorage.setItem(
              "cuidoPreferredLanguage",
              languageSelector.value
            );
          });
        }

        // Toggle sidebar visibility for both mobile and desktop
        if (menuToggleButton && chatSidebar && sidebarOverlay) {
          menuToggleButton.addEventListener("click", (event) => {
            event.stopPropagation();
            chatSidebar.classList.toggle("open");
            sidebarOverlay.classList.toggle("visible");
          });

          // Close sidebar when clicking outside
          sidebarOverlay.addEventListener("click", () => {
            chatSidebar.classList.remove("open");
            sidebarOverlay.classList.remove("visible");
          });
        }

        themeButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const theme = button.dataset.theme;
            applyTheme(theme);
          });
        });

        if (newChatButton)
          newChatButton.addEventListener("click", createNewChat);

        initializeApp();

        // Apply initial fade-in animations to main content and footer
        if (mainContentPanel) {
          mainContentPanel.style.animation = "fadeIn 0.8s ease-out forwards";
        }
        if (footerElement) {
          footerElement.style.animation = "fadeIn 0.8s ease-out 0.2s forwards";
        }
      });
    </script>
  </body>
</html>
